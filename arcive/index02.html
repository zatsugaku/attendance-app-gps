<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPSÂã§ÊÄ†ÁÆ°ÁêÜ„Ç¢„Éó„É™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 24px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .user-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: block;
        }

        .status-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .status-moving { background: #e8f5e8; color: #2e7d32; }
        .status-working { background: #e3f2fd; color: #1976d2; }

        .location-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .location-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .location-icon {
            width: 20px;
            margin-right: 10px;
            color: #666;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .history-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }

        .history-date {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .history-details {
            font-size: 14px;
            color: #666;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .error {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 10px;
        }

        .login-screen {
            text-align: center;
            margin-top: 50px;
        }

        .login-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: background 0.3s ease;
        }

        .login-btn:hover {
            background: #3367d6;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ GPSÂã§ÊÄ†ÁÆ°ÁêÜ„Ç¢„Éó„É™</h1>
        </div>

        <div id="loginScreen" class="status-card login-screen">
            <h2>„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</h2>
            <p style="margin: 20px 0; color: #666;">Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <button id="loginBtn" class="login-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Google„Åß„É≠„Ç∞„Ç§„É≥
            </button>
        </div>

        <div id="mainApp" style="display: none;">
            <div class="status-card">
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="„Ç¢„Éê„Çø„Éº">
                    <h3 id="userName">„É¶„Éº„Ç∂„ÉºÂêç</h3>
                    <span id="statusIndicator" class="status-indicator status-moving">ÁßªÂãï‰∏≠</span>
                </div>

                <div class="location-info">
                    <div class="location-row">
                        <span class="location-icon">üìç</span>
                        <span id="locationStatus">‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...</span>
                    </div>
                    <div class="location-row">
                        <span class="location-icon">üè†</span>
                        <span id="addressInfo">‰ΩèÊâÄ„ÇíÂèñÂæó‰∏≠...</span>
                    </div>
                    <div class="location-row">
                        <span class="location-icon">üìè</span>
                        <span id="accuracyInfo">Á≤æÂ∫¶ÊÉÖÂ†±</span>
                    </div>
                </div>

                <div class="button-group">
                    <button id="startBtn" class="btn btn-primary">ÈñãÂßã</button>
                    <button id="completeBtn" class="btn btn-danger" disabled>ÂÆå‰∫Ü</button>
                </div>

                <div class="button-group">
                    <button id="logoutBtn" class="btn btn-secondary">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>

            <div class="history-section">
                <h3>üìã Âã§ÊÄ†Â±•Ê≠¥</h3>
                <div id="historyList">
                    <div class="loading">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, where, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyDUgTnS9eabHA8iyY_WMMIrh0ZdxsAF_Ds",
            authDomain: "attendance-app-gps.firebaseapp.com",
            projectId: "attendance-app-gps",
            storageBucket: "attendance-app-gps.firebasestorage.app",
            messagingSenderId: "389712797536",
            appId: "1:389712797536:web:f872695e0a877fb8900805",
            measurementId: "G-ELGT30EGBF"
        };

        // Google Geocoding APIË®≠ÂÆö
        const GOOGLE_API_KEY = 'AIzaSyDw4jTRfCDTidsUfd0ewoDPd908Pg_zk38';

        // FirebaseÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentUser = null;
        let currentStatus = 'moving';
        let currentLocation = null;
        let currentAddress = '‰ΩèÊâÄ‰∏çÊòé';

        // DOMË¶ÅÁ¥†
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const statusIndicator = document.getElementById('statusIndicator');
        const locationStatus = document.getElementById('locationStatus');
        const addressInfo = document.getElementById('addressInfo');
        const accuracyInfo = document.getElementById('accuracyInfo');
        const startBtn = document.getElementById('startBtn');
        const completeBtn = document.getElementById('completeBtn');
        const historyList = document.getElementById('historyList');

        // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showMainApp();
                loadUserData();
                loadUserStatus();
                startLocationTracking();
                loadHistory();
            } else {
                showLoginScreen();
            }
        });

        // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
        loginBtn.addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                alert('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        });

        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
            }
        });

        // ÁîªÈù¢Ë°®Á§∫Âàá„ÇäÊõø„Åà
        function showLoginScreen() {
            loginScreen.style.display = 'block';
            mainApp.style.display = 'none';
        }

        function showMainApp() {
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
        }

        // „É¶„Éº„Ç∂„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        function loadUserData() {
            if (currentUser) {
                userName.textContent = currentUser.displayName || '„É¶„Éº„Ç∂„Éº';
                userAvatar.src = currentUser.photoURL || 'https://via.placeholder.com/60';
            }
        }

        // „É¶„Éº„Ç∂„Éº„Çπ„ÉÜ„Éº„Çø„ÇπË™≠„ÅøËæº„Åø
        async function loadUserStatus() {
            if (!currentUser) return;

            try {
                const userDoc = doc(db, 'users', currentUser.uid);
                const docSnap = await getDoc(userDoc);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    currentStatus = userData.status || 'moving';
                    updateStatusDisplay(currentStatus);
                } else {
                    // ÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊôÇ„Å´„É¶„Éº„Ç∂„Éº„Éâ„Ç≠„É•„É°„É≥„Éà‰ΩúÊàê
                    await setDoc(userDoc, {
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        email: currentUser.email,
                        status: 'moving',
                        lastUpdated: new Date()
                    });
                    currentStatus = 'moving';
                    updateStatusDisplay('moving');
                }
            } catch (error) {
                console.error('„Çπ„ÉÜ„Éº„Çø„ÇπË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                currentStatus = 'moving';
                updateStatusDisplay('moving');
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫Êõ¥Êñ∞
        function updateStatusDisplay(status) {
            if (status === 'working') {
                statusIndicator.textContent = 'Ê•≠Âãô‰∏≠';
                statusIndicator.className = 'status-indicator status-working';
                startBtn.disabled = true;
                completeBtn.disabled = false;
            } else {
                statusIndicator.textContent = 'ÁßªÂãï‰∏≠';
                statusIndicator.className = 'status-indicator status-moving';
                startBtn.disabled = false;
                completeBtn.disabled = true;
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò
        async function saveUserStatus(status) {
            if (!currentUser) return;

            try {
                const userDoc = doc(db, 'users', currentUser.uid);
                await setDoc(userDoc, {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    email: currentUser.email,
                    status: status,
                    lastUpdated: new Date()
                }, { merge: true });
                
                currentStatus = status;
                updateStatusDisplay(status);
            } catch (error) {
                console.error('„Çπ„ÉÜ„Éº„Çø„Çπ‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        // ‰ΩçÁΩÆÊÉÖÂ†±ËøΩË∑°ÈñãÂßã
        function startLocationTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        updateLocationDisplay();
                        getAddressFromCoordinates(currentLocation.latitude, currentLocation.longitude);
                    },
                    (error) => {
                        console.error('‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº:', error);
                        locationStatus.textContent = '‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                        addressInfo.textContent = '‰ΩèÊâÄ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                locationStatus.textContent = 'GPSÊ©üËÉΩ„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
            }
        }

        // ‰ΩèÊâÄÂ§âÊèõÊ©üËÉΩ
        async function getAddressFromCoordinates(lat, lng) {
            try {
                addressInfo.textContent = '‰ΩèÊâÄ„ÇíÂèñÂæó‰∏≠...';
                
                const response = await fetch(
                    `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GOOGLE_API_KEY}&language=ja`
                );
                const data = await response.json();
                
                console.log('Geocoding API „É¨„Çπ„Éù„É≥„Çπ:', data);
                
                if (data.status === 'OK' && data.results && data.results.length > 0) {
                    currentAddress = data.results[0].formatted_address;
                    addressInfo.textContent = currentAddress;
                    console.log('‰ΩèÊâÄÂèñÂæóÊàêÂäü:', currentAddress);
                } else {
                    console.error('Geocoding API „Ç®„É©„Éº:', data.status, data.error_message);
                    addressInfo.textContent = `‰ΩèÊâÄÂèñÂæó„Ç®„É©„Éº: ${data.status}`;
                    if (data.error_message) {
                        console.error('Ë©≥Á¥∞„Ç®„É©„Éº:', data.error_message);
                        addressInfo.textContent += ` - ${data.error_message}`;
                    }
                }
            } catch (error) {
                console.error('‰ΩèÊâÄÂ§âÊèõ„Ç®„É©„Éº:', error);
                addressInfo.textContent = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: ‰ΩèÊâÄ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
            }
        }

        // ‰ΩçÁΩÆÊÉÖÂ†±Ë°®Á§∫Êõ¥Êñ∞
        function updateLocationDisplay() {
            if (currentLocation) {
                locationStatus.textContent = `Á∑ØÂ∫¶: ${currentLocation.latitude.toFixed(6)}, ÁµåÂ∫¶: ${currentLocation.longitude.toFixed(6)}`;
                accuracyInfo.textContent = `Á≤æÂ∫¶: ${Math.round(currentLocation.accuracy)}m`;
            }
        }

        // ÊâìÂàªÂá¶ÁêÜ
        async function recordAttendance(type) {
            if (!currentUser || !currentLocation) {
                alert('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åæ„Åü„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            try {
                const now = new Date();
                const record = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    type: type,
                    timestamp: now,
                    location: currentLocation,
                    address: currentAddress,
                    date: now.toISOString().split('T')[0]
                };

                await addDoc(collection(db, 'attendance'), record);
                
                // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞„Å®‰øùÂ≠ò
                const newStatus = type === 'start' ? 'working' : 'moving';
                await saveUserStatus(newStatus);
                
                alert(`${getTypeDisplayName(type)}„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü\nÂ†¥ÊâÄ: ${currentAddress}`);
            } catch (error) {
                console.error('Ë®òÈå≤„Ç®„É©„Éº:', error);
                alert('Ë®òÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // „Çø„Ç§„ÉóË°®Á§∫ÂêçÂèñÂæó
        function getTypeDisplayName(type) {
            const typeNames = {
                'start': 'Ê•≠ÂãôÈñãÂßã',
                'complete': 'Ê•≠ÂãôÂÆå‰∫Ü'
            };
            return typeNames[type] || type;
        }

        // Â±•Ê≠¥Ë™≠„ÅøËæº„Åø
        function loadHistory() {
            if (!currentUser) return;

            const q = query(
                collection(db, 'attendance'),
                where('userId', '==', currentUser.uid),
                orderBy('timestamp', 'desc')
            );

            onSnapshot(q, (querySnapshot) => {
                const records = [];
                querySnapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                displayHistory(records);
            });
        }

        // Â±•Ê≠¥Ë°®Á§∫
        function displayHistory(records) {
            if (records.length === 0) {
                historyList.innerHTML = '<div class="loading">Â±•Ê≠¥„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            const groupedRecords = groupRecordsByDate(records);
            let html = '';

            for (const [date, dateRecords] of Object.entries(groupedRecords)) {
                html += `<div class="history-item">`;
                html += `<div class="history-date">${formatDate(date)}</div>`;
                
                dateRecords.forEach(record => {
                    const time = record.timestamp.toDate ? 
                        record.timestamp.toDate().toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) :
                        new Date(record.timestamp).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                    
                    html += `<div class="history-details">`;
                    html += `${time} - ${getTypeDisplayName(record.type)}`;
                    if (record.address) {
                        html += `<br>üìç ${record.address}`;
                    }
                    html += `</div>`;
                });
                
                html += `</div>`;
            }

            historyList.innerHTML = html;
        }

        // Êó•‰ªò„Åß„Ç∞„É´„Éº„ÉóÂåñ
        function groupRecordsByDate(records) {
            const grouped = {};
            records.forEach(record => {
                const date = record.timestamp.toDate ? 
                    record.timestamp.toDate().toISOString().split('T')[0] :
                    new Date(record.timestamp).toISOString().split('T')[0];
                
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(record);
            });
            return grouped;
        }

        // Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            if (dateString === today.toISOString().split('T')[0]) {
                return '‰ªäÊó• (' + date.toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'}) + ')';
            } else if (dateString === yesterday.toISOString().split('T')[0]) {
                return 'Êò®Êó• (' + date.toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'}) + ')';
            } else {
                return date.toLocaleDateString('ja-JP', {year: 'numeric', month: 'short', day: 'numeric'});
            }
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        startBtn.addEventListener('click', () => recordAttendance('start'));
        completeBtn.addEventListener('click', () => recordAttendance('complete'));
    </script>
</body>
</html>