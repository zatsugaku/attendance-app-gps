<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…ç”»é¢ - GPSå‹¤æ€ ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .user-info {
            color: #666;
            font-size: 14px;
        }
        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .logout-btn:hover {
            background: #ff5252;
        }
        
        /* ç®¡ç†è€…ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .admin-management {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .admin-management h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .admin-list {
            margin-bottom: 20px;
        }
        .admin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .admin-email {
            font-weight: 500;
            color: #333;
        }
        .admin-role {
            font-size: 12px;
            color: #667eea;
            background: #e8eaf6;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        .delete-admin-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .delete-admin-btn:hover {
            background: #ff5252;
        }
        .delete-admin-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .add-admin-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .add-admin-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .add-admin-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .add-admin-btn:hover {
            background: #5568d3;
        }
        
        /* å‹¤æ€ è¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .date-filter label {
            font-weight: 500;
            color: #333;
        }
        .date-filter input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .filter-btn, .export-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-btn:hover, .export-btn:hover {
            background: #5568d3;
        }
        .stats {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .stat-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .records {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .records h2 {
            color: #667eea;
            margin-bottom: 15px;
        }
        .record-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .record-user {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        .record-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .type-start {
            background: #4caf50;
            color: white;
        }
        .type-complete {
            background: #2196f3;
            color: white;
        }
        .record-time {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .record-address {
            color: #888;
            font-size: 13px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .no-access {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .no-access h2 {
            color: #ff6b6b;
            margin-bottom: 10px;
        }
        .no-access p {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ç®¡ç†è€…ç”»é¢</h1>
            <div class="user-info">
                ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <span id="userEmail">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div id="noAccessMessage" class="no-access" style="display: none;">
            <h2>ğŸš« ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</h2>
            <p>ã“ã®ç”»é¢ã¯ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚</p>
            <button class="logout-btn" onclick="logout()" style="margin-top: 20px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div id="adminContent" style="display: none;">
            <!-- ç®¡ç†è€…ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="admin-management">
                <h2>ğŸ‘¥ ç®¡ç†è€…ç®¡ç†</h2>
                <div class="admin-list" id="adminList">
                    <div class="loading">ç®¡ç†è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div class="add-admin-form">
                    <input type="email" 
                           id="newAdminEmail" 
                           class="add-admin-input" 
                           placeholder="æ–°ã—ã„ç®¡ç†è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹: user@example.comï¼‰">
                    <button class="add-admin-btn" onclick="addAdmin()">ç®¡ç†è€…ã‚’è¿½åŠ </button>
                </div>
            </div>

            <!-- å‹¤æ€ è¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="controls">
                <div class="date-filter">
                    <label>æœŸé–“æŒ‡å®š:</label>
                    <input type="date" id="startDate">
                    <label>ã€œ</label>
                    <input type="date" id="endDate">
                    <button class="filter-btn" onclick="loadRecords()">çµã‚Šè¾¼ã¿</button>
                    <button class="export-btn" onclick="exportCSV()">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalEmployees">0</div>
                    <div class="stat-label">ç™»éŒ²å¾“æ¥­å“¡æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalRecords">0</div>
                    <div class="stat-label">ç·è¨˜éŒ²æ•°</div>
                </div>
            </div>

            <div class="records">
                <h2>å‹¤æ€ è¨˜éŒ²ä¸€è¦§</h2>
                <div id="recordsList">
                    <div class="loading">è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc, deleteDoc, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDUgTnS9eabHA8iyY_WMMIrh0ZdxsAF_Ds",
            authDomain: "attendance-app-gps.firebaseapp.com",
            projectId: "attendance-app-gps",
            storageBucket: "attendance-app-gps.firebasestorage.app",
            messagingSenderId: "389712797536",
            appId: "1:389712797536:web:f872695e0a877fb8900805",
            measurementId: "G-ELGT30EGBF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isAdmin = false;
        let isSuperAdmin = false;

        // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
        async function checkAdminStatus(email) {
            try {
                const adminDoc = doc(db, 'admins', email);
                const adminSnap = await getDoc(adminDoc);
                
                if (adminSnap.exists()) {
                    const adminData = adminSnap.data();
                    isAdmin = true;
                    isSuperAdmin = adminData.role === 'super_admin';
                    return true;
                }
                return false;
            } catch (error) {
                console.error('ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // èªè¨¼çŠ¶æ…‹ç›£è¦–
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                
                // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
                const hasAccess = await checkAdminStatus(user.email);
                
                if (hasAccess) {
                    document.getElementById('adminContent').style.display = 'block';
                    document.getElementById('noAccessMessage').style.display = 'none';
                    loadAdmins();
                    loadRecords();
                } else {
                    document.getElementById('adminContent').style.display = 'none';
                    document.getElementById('noAccessMessage').style.display = 'block';
                }
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã¯Googleèªè¨¼
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        });

        // ç®¡ç†è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadAdmins() {
            try {
                const adminsQuery = query(collection(db, 'admins'));
                const adminsSnapshot = await getDocs(adminsQuery);
                
                const adminListDiv = document.getElementById('adminList');
                adminListDiv.innerHTML = '';
                
                if (adminsSnapshot.empty) {
                    adminListDiv.innerHTML = '<div class="loading">ç®¡ç†è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                    return;
                }
                
                adminsSnapshot.forEach((doc) => {
                    const adminData = doc.data();
                    const adminItem = document.createElement('div');
                    adminItem.className = 'admin-item';
                    
                    const isCurrentUserSuperAdmin = isSuperAdmin;
                    const isSuperAdminUser = adminData.role === 'super_admin';
                    const canDelete = isCurrentUserSuperAdmin && doc.id !== currentUser.email;
                    
                    adminItem.innerHTML = `
                        <div>
                            <span class="admin-email">${doc.id}</span>
                            ${isSuperAdminUser ? '<span class="admin-role">æœ€é«˜æ¨©é™è€…</span>' : '<span class="admin-role">ç®¡ç†è€…</span>'}
                        </div>
                        <button class="delete-admin-btn" 
                                onclick="deleteAdmin('${doc.id}')" 
                                ${!canDelete ? 'disabled' : ''}>
                            ${doc.id === currentUser.email ? 'è‡ªåˆ†' : 'å‰Šé™¤'}
                        </button>
                    `;
                    
                    adminListDiv.appendChild(adminItem);
                });
            } catch (error) {
                console.error('ç®¡ç†è€…ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('adminList').innerHTML = '<div class="error">ç®¡ç†è€…ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ç®¡ç†è€…ã‚’è¿½åŠ 
        window.addAdmin = async function() {
            const emailInput = document.getElementById('newAdminEmail');
            const email = emailInput.value.trim();
            
            if (!email) {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!email.includes('@')) {
                alert('æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!isSuperAdmin) {
                alert('ç®¡ç†è€…ã®è¿½åŠ æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                // æ—¢ã«ç®¡ç†è€…ã‹ç¢ºèª
                const adminDoc = doc(db, 'admins', email);
                const adminSnap = await getDoc(adminDoc);
                
                if (adminSnap.exists()) {
                    alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç®¡ç†è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                    return;
                }
                
                // æ–°ã—ã„ç®¡ç†è€…ã‚’è¿½åŠ 
                await setDoc(adminDoc, {
                    email: email,
                    role: 'admin',
                    addedAt: new Date(),
                    addedBy: currentUser.email
                });
                
                alert(`${email} ã‚’ç®¡ç†è€…ã¨ã—ã¦è¿½åŠ ã—ã¾ã—ãŸ`);
                emailInput.value = '';
                loadAdmins();
            } catch (error) {
                console.error('ç®¡ç†è€…è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('ç®¡ç†è€…ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        };

        // ç®¡ç†è€…ã‚’å‰Šé™¤
        window.deleteAdmin = async function(email) {
            if (!isSuperAdmin) {
                alert('ç®¡ç†è€…ã®å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (email === currentUser.email) {
                alert('è‡ªåˆ†è‡ªèº«ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“');
                return;
            }
            
            if (!confirm(`${email} ã‚’ç®¡ç†è€…ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'admins', email));
                alert(`${email} ã‚’ç®¡ç†è€…ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ`);
                loadAdmins();
            } catch (error) {
                console.error('ç®¡ç†è€…å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('ç®¡ç†è€…ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        };

        // å‹¤æ€ è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿
        window.loadRecords = async function() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let recordsQuery = query(
                    collection(db, 'attendance'),
                    orderBy('timestamp', 'desc')
                );
                
                if (startDate && endDate) {
                    recordsQuery = query(
                        collection(db, 'attendance'),
                        where('date', '>=', startDate),
                        where('date', '<=', endDate),
                        orderBy('date', 'desc'),
                        orderBy('timestamp', 'desc')
                    );
                }
                
                const recordsSnapshot = await getDocs(recordsQuery);
                const recordsListDiv = document.getElementById('recordsList');
                
                if (recordsSnapshot.empty) {
                    recordsListDiv.innerHTML = '<div class="loading">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    document.getElementById('totalRecords').textContent = '0';
                    return;
                }
                
                recordsListDiv.innerHTML = '';
                const uniqueUsers = new Set();
                
                recordsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    uniqueUsers.add(data.userId);
                    
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'record-item';
                    
                    const timestamp = data.timestamp.toDate();
                    const timeStr = timestamp.toLocaleString('ja-JP');
                    
                    const typeText = data.type === 'start' ? 'æ¥­å‹™é–‹å§‹' : 'æ¥­å‹™å®Œäº†';
                    const typeClass = data.type === 'start' ? 'type-start' : 'type-complete';
                    
                    recordDiv.innerHTML = `
                        <div class="record-header">
                            <span class="record-user">${data.userName}</span>
                            <span class="record-type ${typeClass}">${typeText}</span>
                        </div>
                        <div class="record-time">â° ${timeStr}</div>
                        <div class="record-address">ğŸ“ ${data.address || 'ä½æ‰€æƒ…å ±ãªã—'}</div>
                    `;
                    
                    recordsListDiv.appendChild(recordDiv);
                });
                
                document.getElementById('totalEmployees').textContent = uniqueUsers.size;
                document.getElementById('totalRecords').textContent = recordsSnapshot.size;
                
            } catch (error) {
                console.error('è¨˜éŒ²èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('recordsList').innerHTML = '<div class="error">è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        };

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        window.exportCSV = async function() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let recordsQuery = query(
                    collection(db, 'attendance'),
                    orderBy('timestamp', 'desc')
                );
                
                if (startDate && endDate) {
                    recordsQuery = query(
                        collection(db, 'attendance'),
                        where('date', '>=', startDate),
                        where('date', '<=', endDate),
                        orderBy('date', 'desc'),
                        orderBy('timestamp', 'desc')
                    );
                }
                
                const recordsSnapshot = await getDocs(recordsQuery);
                
                if (recordsSnapshot.empty) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                let csv = '\uFEFF'; // BOM for Excel
                csv += 'æ—¥ä»˜,æ™‚åˆ»,å¾“æ¥­å“¡å,ç¨®åˆ¥,ä½æ‰€\n';
                
                recordsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const timestamp = data.timestamp.toDate();
                    const date = timestamp.toLocaleDateString('ja-JP');
                    const time = timestamp.toLocaleTimeString('ja-JP');
                    const type = data.type === 'start' ? 'æ¥­å‹™é–‹å§‹' : 'æ¥­å‹™å®Œäº†';
                    
                    csv += `${date},${time},${data.userName},${type},"${data.address || ''}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `å‹¤æ€ è¨˜éŒ²_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        };

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        };
    </script>
</body>
</html>