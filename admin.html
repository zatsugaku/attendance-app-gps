<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者画面 - オフィスタイムカード</title>
    <link rel="stylesheet" href="css/admin-styles.css">
</head>
<body>
    <div id="loading" class="loading">読み込み中...</div>

    <div id="app" style="display: none;">
        <div class="container">
            <div class="card">
                <div class="header">
                    <h1>👥 管理者画面</h1>
                    <div class="user-info" id="userInfo"></div>
                </div>

                <div id="messageArea"></div>

                <!-- タブナビゲーション -->
                <div class="tab-nav">
                    <button class="tab-button active" onclick="switchTab('records')">📋 記録一覧</button>
                    <button class="tab-button" onclick="switchTab('settings')">⚙️ 基本設定</button>
                    <button class="tab-button" onclick="switchTab('monthly')">📊 月次集計</button>
                    <button class="tab-button" onclick="switchTab('manual')">✏️ 手動入力</button>
                </div>

                <!-- タブ1: 記録一覧 -->
                <div id="tab-records" class="tab-content active">
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalRecords">0</div>
                            <div class="stat-label">総記録数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="todayClockIn">0</div>
                            <div class="stat-label">本日の出勤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="todayClockOut">0</div>
                            <div class="stat-label">本日の退勤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="todayBreaks">0</div>
                            <div class="stat-label">本日の外出</div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <h3 style="margin-bottom: 20px; color: #333;">🔍 フィルター</h3>
                        <div class="filter-row">
                            <label>表示日付:</label>
                            <button class="button button-secondary button-small" onclick="changeDate(-1)">◀ 前日</button>
                            <input type="date" id="displayDate">
                            <button class="button button-secondary button-small" onclick="changeDate(1)">翌日 ▶</button>
                            <button class="button button-secondary button-small" onclick="goToToday()">今日</button>
                        </div>
                        <div class="filter-row">
                            <label>従業員:</label>
                            <select id="employeeFilter">
                                <option value="">全従業員</option>
                            </select>
                        </div>
                        <div class="filter-row">
                            <label>種別:</label>
                            <select id="typeFilter">
                                <option value="">全て</option>
                                <option value="clock_in">出勤</option>
                                <option value="clock_out">退勤</option>
                                <option value="break_start">外出</option>
                                <option value="break_end">戻り</option>
                            </select>
                        </div>
                        <div class="filter-row">
                            <button class="button button-primary" onclick="filterRecords()">更新</button>
                            <button class="button button-secondary" onclick="exportToCSV()">CSV出力</button>
                        </div>
                    </div>

                    <h2 style="color: #667eea; margin-bottom: 15px; font-size: 24px;">📋 勤怠記録一覧</h2>
                    <div class="table-container">
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>日付</th>
                                    <th>従業員</th>
                                    <th>出勤時刻</th>
                                    <th>退勤時刻</th>
                                    <th>外出時刻</th>
                                    <th>戻り時刻</th>
                                    <th>勤務時間</th>
                                    <th>PC情報</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 50px; color: #999;">
                                        読み込み中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- タブ2: 基本設定 -->
                <div id="tab-settings" class="tab-content">
                    <div class="section">
                        <h3>🏢 会社情報</h3>
                        <div class="form-group">
                            <label>会社名</label>
                            <div class="current-value" id="currentCompanyName">未設定</div>
                            <input type="text" id="companyName" placeholder="株式会社〇〇">
                        </div>
                        <div class="form-group">
                            <label>締め日</label>
                            <div class="current-value" id="currentClosingDay">未設定</div>
                            <select id="closingDay">
                                <option value="月末">月末</option>
                                <option value="5">5日</option>
                                <option value="10">10日</option>
                                <option value="15">15日</option>
                                <option value="20">20日</option>
                                <option value="25">25日</option>
                            </select>
                        </div>
                    </div>

                    <div class="section">
                        <h3>⏰ 勤務時間設定</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>始業時刻</label>
                                <div class="current-value" id="currentStartTime">未設定</div>
                                <input type="time" id="startTime" value="09:00">
                            </div>
                            <div class="form-group">
                                <label>終業時刻</label>
                                <div class="current-value" id="currentEndTime">未設定</div>
                                <input type="time" id="endTime" value="18:00">
                            </div>
                            <div class="form-group">
                                <label>休憩時間（分）</label>
                                <div class="current-value" id="currentBreakTime">未設定</div>
                                <input type="number" id="breakTime" value="60" min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>所定労働時間（時間/日）</label>
                            <div class="current-value" id="currentStandardWorkTime">未設定</div>
                            <input type="number" id="standardWorkTime" value="8" min="1" max="24" step="0.5">
                        </div>
                    </div>

                    <div class="section">
                        <h3>📊 残業・遅刻設定</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>残業開始時間（時間）</label>
                                <div class="current-value" id="currentOvertimeThreshold">未設定</div>
                                <input type="number" id="overtimeThreshold" value="8" min="1" step="0.5">
                            </div>
                            <div class="form-group">
                                <label>遅刻判定時間（分）</label>
                                <div class="current-value" id="currentLateThreshold">未設定</div>
                                <input type="number" id="lateThreshold" value="30" min="1">
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h3>📅 休日設定</h3>
                        <div class="form-group">
                            <label>定休日</label>
                            <div class="current-value" id="currentWeekends">未設定</div>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <label><input type="checkbox" id="sun" value="0"> 日</label>
                                <label><input type="checkbox" id="mon" value="1"> 月</label>
                                <label><input type="checkbox" id="tue" value="2"> 火</label>
                                <label><input type="checkbox" id="wed" value="3"> 水</label>
                                <label><input type="checkbox" id="thu" value="4"> 木</label>
                                <label><input type="checkbox" id="fri" value="5"> 金</label>
                                <label><input type="checkbox" id="sat" value="6"> 土</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="includeHolidays">
                                祝日を休日とする
                            </label>
                        </div>
                    </div>

                    <button class="button button-primary" onclick="saveSettings()">💾 設定を保存</button>

                    <!-- 従業員管理セクション -->
                    <div class="section" style="margin-top: 40px;">
                        <h3>👥 従業員管理</h3>
                        <div class="table-container">
                            <table class="records-table">
                                <thead>
                                    <tr>
                                        <th>従業員名</th>
                                        <th>メールアドレス</th>
                                        <th>始業時刻</th>
                                        <th>終業時刻</th>
                                        <th>休憩時間</th>
                                        <th>所定労働時間</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="employeesTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 30px; color: #999;">
                                            読み込み中...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- タブ3: 月次集計 -->
                <div id="tab-monthly" class="tab-content">
                    <div class="section">
                        <h3>📊 月次集計</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label>対象年月</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="targetYear">
                                        <option value="2024">2024年</option>
                                        <option value="2025">2025年</option>
                                        <option value="2026">2026年</option>
                                    </select>
                                    <select id="targetMonth">
                                        <option value="1">1月</option>
                                        <option value="2">2月</option>
                                        <option value="3">3月</option>
                                        <option value="4">4月</option>
                                        <option value="5">5月</option>
                                        <option value="6">6月</option>
                                        <option value="7">7月</option>
                                        <option value="8">8月</option>
                                        <option value="9">9月</option>
                                        <option value="10">10月</option>
                                        <option value="11">11月</option>
                                        <option value="12">12月</option>
                                    </select>
                                </div>
                                <div class="help-text" id="periodDisplay">集計期間: 計算中...</div>
                            </div>

                            <div class="form-group">
                                <label>従業員選択</label>
                                <select id="monthlyEmployeeFilter">
                                    <option value="">全従業員</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-row">
                            <button class="button button-primary" onclick="calculateMonthlySummary()">集計実行</button>
                            <button class="button button-secondary" onclick="exportMonthlySummaryCSV()">CSV出力</button>
                        </div>
                    </div>

                    <div id="monthlySummaryResults" style="display: none;">
                        <h2 style="color: #667eea; margin-bottom: 15px; font-size: 24px;">📈 集計結果</h2>

                        <div class="table-container">
                            <table class="records-table">
                                <thead>
                                    <tr>
                                        <th>従業員名</th>
                                        <th>出勤日数</th>
                                        <th>総労働時間</th>
                                        <th>平均労働時間</th>
                                        <th>残業時間</th>
                                        <th>遅刻回数</th>
                                        <th>早退回数</th>
                                        <th>欠勤日数</th>
                                        <th>有給取得</th>
                                        <th>外出回数</th>
                                        <th>総外出時間</th>
                                        <th>出勤率</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlySummaryTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- タブ4: 手動入力 -->
                <div id="tab-manual" class="tab-content">
                    <!-- 打刻修正 -->
                    <div class="section">
                        <h3>⏰ 打刻の追加・修正</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label>従業員選択</label>
                                <select id="manualEmployeeSelect">
                                    <option value="">選択してください</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>日付</label>
                                <input type="date" id="manualDate">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>打刻種別</label>
                                <select id="manualType">
                                    <option value="clock_in">出勤</option>
                                    <option value="clock_out">退勤</option>
                                    <option value="break_start">外出</option>
                                    <option value="break_end">戻り</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>時刻</label>
                                <input type="time" id="manualTime">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>理由（任意）</label>
                            <input type="text" id="manualReason" placeholder="例: 打刻忘れ、時刻修正">
                            <div class="help-text">※この打刻は「✏️手動」マークが付きます</div>
                        </div>

                        <button class="button button-primary" onclick="addManualRecord()">✏️ 打刻を追加</button>
                    </div>

                    <!-- 有給休暇登録 -->
                    <div class="section">
                        <h3>🌴 有給休暇の登録</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label>従業員選択</label>
                                <select id="paidLeaveEmployee">
                                    <option value="">選択してください</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>日付</label>
                                <input type="date" id="paidLeaveDate">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>休暇タイプ</label>
                                <select id="paidLeaveType">
                                    <option value="full_day">全休（1.0日）</option>
                                    <option value="half_day_am">午前半休（0.5日）</option>
                                    <option value="half_day_pm">午後半休（0.5日）</option>
                                    <option value="hourly">時間単位</option>
                                </select>
                            </div>

                            <div class="form-group" id="paidLeaveHoursGroup" style="display: none;">
                                <label>時間数（時間単位の場合）</label>
                                <input type="number" id="paidLeaveHours" min="0.5" max="8" step="0.5" placeholder="例: 2.0">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>理由（任意）</label>
                            <input type="text" id="paidLeaveReason" placeholder="例: 私用、通院">
                        </div>

                        <button class="button button-primary" onclick="addPaidLeave()">🌴 有給休暇を登録</button>
                    </div>

                    <!-- 欠勤登録 -->
                    <div class="section">
                        <h3>🏥 欠勤の登録</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label>従業員選択</label>
                                <select id="absenceEmployee">
                                    <option value="">選択してください</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>日付</label>
                                <input type="date" id="absenceDate">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>欠勤理由（任意）</label>
                            <input type="text" id="absenceReason" placeholder="例: 病欠、忌引">
                        </div>

                        <button class="button button-primary" onclick="addAbsence()">🏥 欠勤を登録</button>
                    </div>
                </div>

                <button class="button button-secondary" onclick="logout()" style="width: 100%; margin-top: 30px;">
                    ログアウト
                </button>
            </div>
        </div>
    </div>

    <div id="accessDenied" class="access-denied" style="display: none;">
        <div class="card" style="max-width: 600px; margin: 0 auto;">
            <h2 style="color: #f5576c; margin-bottom: 20px;">アクセス拒否</h2>
            <p style="margin-bottom: 25px;">管理者権限がありません。</p>
            <button class="button button-primary" onclick="logout()">ログアウト</button>
        </div>
    </div>

    <!-- 従業員編集モーダル -->
    <div id="employeeEditModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 600px; margin: 20px; background: white;">
            <h2 style="color: #667eea; margin-bottom: 20px; font-size: 24px;">👤 従業員勤務時間設定</h2>

            <div id="employeeEditMessageArea"></div>

            <div class="form-group">
                <label>従業員名</label>
                <div class="current-value" id="employeeEditName">-</div>
            </div>

            <div class="form-group">
                <label>メールアドレス</label>
                <div class="current-value" id="employeeEditEmail">-</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>始業時刻</label>
                    <input type="time" id="employeeEditStartTime">
                </div>

                <div class="form-group">
                    <label>終業時刻</label>
                    <input type="time" id="employeeEditEndTime">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>休憩時間（分）</label>
                    <input type="number" id="employeeEditBreakTime" min="0" step="1">
                </div>

                <div class="form-group">
                    <label>所定労働時間（時間）</label>
                    <input type="number" id="employeeEditStandardWorkTime" min="1" max="24" step="0.5">
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="button button-primary" onclick="saveEmployeeWorkTime()">✅ 保存</button>
                <button class="button button-secondary" onclick="closeEmployeeEditModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 編集モーダル -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 600px; margin: 20px; background: white;">
            <h2 style="color: #667eea; margin-bottom: 20px; font-size: 24px;">⏰ 打刻時刻の編集</h2>

            <div id="editMessageArea"></div>

            <div class="form-group">
                <label>従業員名</label>
                <div class="current-value" id="editUserName">-</div>
            </div>

            <div class="form-group">
                <label>種別</label>
                <div class="current-value" id="editType">-</div>
            </div>

            <div class="form-group">
                <label>現在の日時</label>
                <div class="current-value" id="editCurrentTime">-</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>新しい日付</label>
                    <input type="date" id="editDate">
                </div>

                <div class="form-group">
                    <label>新しい時刻</label>
                    <input type="time" id="editTime">
                </div>
            </div>

            <div class="form-group">
                <label>変更理由（必須）</label>
                <input type="text" id="editReason" placeholder="例: 打刻忘れの修正、時刻の誤入力">
                <div class="help-text">※変更履歴として保存されます</div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: space-between;">
                <button class="button button-danger" onclick="deleteFromEditModal()">🗑️ 削除</button>
                <div style="display: flex; gap: 10px;">
                    <button class="button button-primary" onclick="saveEdit()">✅ 変更を保存</button>
                    <button class="button button-secondary" onclick="closeEditModal()">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 統合編集モーダル -->
    <div id="unifiedEditModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 700px; margin: 20px; background: white; max-height: 90vh; overflow-y: auto;">
            <h2 style="color: #667eea; margin-bottom: 20px; font-size: 24px;" id="unifiedEditTitle">📋 打刻編集</h2>

            <div id="unifiedEditMessageArea"></div>

            <!-- 打刻一覧 -->
            <div id="unifiedEditRecordsList" style="margin-bottom: 20px;">
                <!-- JavaScript で動的生成 -->
            </div>

            <!-- 新規追加セクション -->
            <div style="border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                <h3 style="color: #333; font-size: 18px; margin-bottom: 15px;">➕ 新規打刻を追加</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>種別</label>
                        <select id="unifiedAddType">
                            <option value="clock_in">出勤</option>
                            <option value="clock_out">退勤</option>
                            <option value="break_start">外出</option>
                            <option value="break_end">戻り</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>時刻</label>
                        <input type="time" id="unifiedAddTime">
                    </div>
                </div>
                <button class="button button-primary button-small" onclick="addRecordFromUnifiedModal()">➕ 追加</button>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="button button-secondary" onclick="closeUnifiedEditModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Core modules -->
    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/utils.js"></script>
    <script type="module" src="js/auth.js"></script>

    <!-- Feature modules -->
    <script type="module" src="js/attendance.js"></script>
    <script type="module" src="js/manual.js"></script>
    <script type="module" src="js/monthly.js"></script>
    <script type="module" src="js/settings.js"></script>
    <script type="module" src="js/employees.js"></script>
    <script type="module" src="js/edit.js"></script>

    <!-- Main initialization -->
    <script type="module">
        import { initAuth, getCurrentUser } from './js/auth.js';
        import { initializeAttendanceModule } from './js/attendance.js';
        import { initializeManualModule } from './js/manual.js';
        import { initializeMonthlyModule } from './js/monthly.js';
        import { initializeSettingsModule } from './js/settings.js';
        import { initializeEmployeesModule } from './js/employees.js';
        import { settingsManager } from './js/settings.js';
        import { initializeEditModule } from './js/edit.js';
        import { db } from './js/config.js';

        // Initialize authentication
        initAuth().then(user => {
            if (user && user.isAdmin) {
                // Initialize all modules
                initializeAttendanceModule(db);
                initializeManualModule();
                initializeMonthlyModule();
                initializeSettingsModule();

                // Initialize employees module after settings loaded
                setTimeout(() => {
                    const defaultSettings = settingsManager.getSettings();
                    initializeEmployeesModule(defaultSettings);
                }, 1000);

                // Initialize edit module with reload callback
                const reloadRecords = async (preserveFilters) => {
                    // This will be called from attendance module
                    if (window.loadRecords) {
                        await window.loadRecords(db, preserveFilters);
                    }
                };
                initializeEditModule(user, reloadRecords);

                // Set global references for modules that need them
                window.currentUser = user;
            }
        }).catch(error => {
            console.error('Authentication initialization failed:', error);
        });

        // Tab switching function
        window.switchTab = function(tabName) {
            const tabs = ['records', 'settings', 'monthly', 'manual'];
            tabs.forEach(tab => {
                const tabContent = document.getElementById(`tab-${tab}`);
                const tabButton = document.querySelector(`[onclick*="switchTab('${tab}')"]`);

                if (tab === tabName) {
                    tabContent.style.display = 'block';
                    tabButton.classList.add('active');
                } else {
                    tabContent.style.display = 'none';
                    tabButton.classList.remove('active');
                }
            });
        };

        console.log('🚀 Admin application initialized');
    </script>
</body>
</html>
